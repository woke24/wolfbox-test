
                        {% assign discount_box_input_border_style = "solid" %}
                        {% assign discount_box_input_border_color = "#a5a5a5" %}
                        {% assign discount_box_input_border_radius = "3" %}
                        {% assign discount_box_input_border_width = "1" %}
                        {% assign discount_box_input_width = "300" %}
                        {% assign discount_box_input_height = "36" %}
                        {% assign discount_box_input_placeholder = "Enter discount code" %}
                        {% assign discount_box_button_color = "#000000" %}
                        {% assign discount_box_button_text_color = "#ffffff" %}
                        {% assign discount_box_button_border_radius = "3" %}
                        {% assign discount_box_button_width = "300" %}
                        {% assign discount_box_button_height = "36" %}
                        {% assign discount_box_header_font_size = "18.72" %}
                        {% assign discount_box_header_color = "#000000" %}
                        {% assign discount_box_layout = "block" %}
                    <script>
    if (typeof BSS_B2B !== "undefined") {
        {% comment %} BSS integrated and compatible discount code with LangShop {% endcomment %}
        if (BSS_B2B.integrate && BSS_B2B.integrate.langShop && BSS_B2B.integrate.langShop.handleAllTranslation) {
            window.addEventListener('load', ()=>{
                setTimeout(()=>{
                    BSS_B2B.integrate.langShop.handleAllTranslation('dc');
                }, 1000)
            })
        }
    }
</script>
<div class="bss-b2b-discount-code-wrapper">
    <p class="bss-b2b-translation-dc-form_header_text">{{ discount_code_form_header_text }}</p>
    <div style= "display:{{discount_box_layout}}; gap: 10px">
        <div id="bss-b2b-discount-code-input-wrapper">
            <input type="text" id="bss-b2b-discount-code-input" placeholder="{{discount_box_input_placeholder}}"/>
            <div id="bss-b2b-discount-code-message"></div>
            <div id="bss-b2b-discount-code-applied-wrapper"></div>
        </div>
        <button id="bss-b2b-discount-code-submit" class="bss-b2b-translation-dc-button_apply"><span>{{ discount_code_apply_button }}</span></button>
    </div>
</div>
<style type="text/css">
    .bss-b2b-translation-dc-form_header_text{
        font-size: {{discount_box_header_font_size}}px;
        font-style: normal;
        font-family: 'Assistant';
        font-weight: 600;
        line-height: 23px;

        color: {{discount_box_header_color}};
        margin-bottom: 10px;
    }
    #bss-b2b-discount-code-submit {
        margin-top: 0;
        height: {{discount_box_button_height}}px;
        width: {{discount_box_button_width}}px;
        appearance: none;
        display: inline-block;
        text-decoration: none;
        text-align: center;
        vertical-align: middle;
        cursor: pointer;
        border: 1px solid transparent;
        border-radius: {{discount_box_button_border_radius}}px;
        padding: 8px 15px;
        background-color: {{discount_box_button_color}};
        color: {{discount_box_button_text_color}};
        letter-spacing: .08em;
        white-space: normal;
        font-size: calc(((var(--font-size-base) - 2) / (var(--font-size-base))) * 1em);
        position: relative;
    }
    #bss-b2b-discount-code-submit.loading span {
        visibility: hidden;
    }
    #bss-b2b-discount-code-submit.loading:after {
        content: "";
        display: block;
        position: absolute;
        top: 50%;
        left: 50%;
        width: 20px;
        height: 20px;
        margin: -10px 0 0 -10px;
        border-radius: 50%;
        border: 2px solid #fff;
        border-top-color: #000;
        animation: spin 0.6s linear infinite;
    }
    .bss-b2b-discount-code-wrapper {
        margin-bottom: 30px;
        display: none; 
        width: 300px;
    }
    #bss-b2b-discount-code-input-wrapper {
        margin-bottom: 10px
    }
    
    #bss-b2b-discount-code-input-wrapper input#bss-b2b-discount-code-input {
        min-height: 35px;
        height: {{discount_box_input_height}}px;
        width: {{discount_box_input_width}}px;
        border: {{discount_box_input_border_width}}px {{discount_box_input_border_color}} {{discount_box_input_border_style}};
        outline: none;
        border-radius: {{discount_box_input_border_radius}}px;
        color: #666;
        padding: 0 15px;
        background: transparent;
    }
    #bss-b2b-clear-discount-code {
        height: 20px;
        width: 20px;
        right: 5px;
        border-radius: 20px;
        background: #a5a5a5;
        color: white;
        font-weight: bold;
        text-align: center;
        cursor: pointer;
        line-height: 20px;
        font-size: 11px;
    }
    #bss-b2b-clear-discount-code:hover {
        background: #ccc;
    }
    #bss-b2b-discount-code-applied-wrapper {
        display: flex;
    }
    div#bss-b2b-discount-code-applied {
        border-radius: 4px;
        background-color: rgba(113,113,113,0.11);
        color: #717171;
        font-size: 15px;
        padding: 5px;
        overflow: hidden;
        margin-left: 5px;
        display: flex;
        align-items: center;
        gap: 15px;
    }
    #bss-b2b-discount-code-message {
        margin-top: 5px;
        margin-left: 5px;
    }

    @media only screen and (max-width: 600px) {
        .bss-b2b-discount-code-wrapper {
            width: 70%;
            margin-left: 15%;
            margin-top: 5%;
        }

    }
    .bss-modal-warning-dc-wrap {
        top: 21%;
        left: 0;
        width: 100%;
        height: 100%;
        display: table;
        z-index: 199999999;
        position: fixed;
        outline: none !important;
        -webkit-backface-visibility: hidden;
        pointer-events: none;
    }
    .bss-modal-dc {
        opacity: .5;
        color: black;
        background-color: white;
        max-width: 500px;
        margin: 18px auto;
        width: calc(100% - 36px);
        pointer-events: auto;
        border: solid white 1px;
    }
    .bss-modal-dc.activeDc {
        opacity: 1;
        transition: all 0.25s ease-in;
        border-width: 0px;
    }
    .bss-modal-dc-header {
        padding: 10px;
        background: #ff9800;
    }
    .bss-modal-dc-title{
        margin-left: 12px;
        color: #000;
        font-size: 20px;
    }
    .bss-modal-dc button {
        user-select: none;
        -webkit-user-select: none;
        cursor: pointer;
        float: right;
        width: unset;
    }
    .bss-modal-dc-button-close {
        font-style: normal;
        margin-top: -5px;
        margin-right: -5px;
        font-size: 35px;
        font-family: Arial, Baskerville, monospace;
        overflow: visible;
        background: transparent;
        border: 0;
        -webkit-appearance: none;
        display: block;
        outline: none;
        padding: 0 0 0 10px;
        box-shadow: none;
        opacity: .65;
    }
    .bss-modal-dc-body {
        padding: 18px;
        background: #ffffff;
        color: #000000;
    }
    .bss-dc-list-warning {
        margin-left: 10px;
        margin-top: -10px;
    }
    .bss-warning-minimum-amount-title {

    }
    .bss-dc-list-warning-amount {

    }
    .bss-amo-text-warning {
        list-style: none;
        position: relative;
        padding: 3px 0 2px 40px;
    }
</style>

<script type="text/javascript" id="bss-b2b-discount-code-script">
    function handleApplyDiscountCode() {

        var hrefArr = window.location.href.split("/");
        var isCart = (hrefArr[hrefArr.length - 1]   == "cart" || hrefArr[hrefArr.length - 1].includes("cart"));
        if (([2631, 2303].indexOf(BSS_B2B.storeId) !== -1) && isCart) {
            let documentWidth = window.innerWidth;
            if (documentWidth > 766) {
                let mobileWrapper = document.querySelector(".cart--root[data-view=mobile] .bss-b2b-discount-code-wrapper");
                if (mobileWrapper) {
                    mobileWrapper.remove();
                }
            } else {
                let unusualMobileEl = document.querySelector('.off-canvas--right-sidebar .cart--root[data-view=mobile] .bss-b2b-discount-code-wrapper');
                let desktopWrapper = document.querySelector(".cart--root[data-view=desktop] .bss-b2b-discount-code-wrapper");
                if (unusualMobileEl) {
                    unusualMobileEl.remove();
                }
                if (desktopWrapper) {
                    desktopWrapper.remove();
                }
            }
        }

        if (BSS_B2B.storeId == 4258 && isCart) {
            let cartDrawerDCForm = document.querySelector('#CartDrawerForm .bss-b2b-discount-code-wrapper');
            if (cartDrawerDCForm) {
                cartDrawerDCForm.remove();
            }
        }

        let btnApplyDiscountCodes = document.querySelectorAll("#bss-b2b-discount-code-submit");
        let messageDiscountCodes = document.querySelectorAll("#bss-b2b-discount-code-message");
        let discountCodeInputs = document.querySelectorAll("#bss-b2b-discount-code-input");
        let discountCodesApplied = document.querySelectorAll("#bss-b2b-discount-code-applied-wrapper");

        if (btnApplyDiscountCodes.length && messageDiscountCodes.length && discountCodeInputs.length && discountCodesApplied.length) {
            for (let j = 0; j < btnApplyDiscountCodes.length; j++) {
                let btnApplyDiscountCode = btnApplyDiscountCodes[j];
                let messageDiscountCode = messageDiscountCodes[j];
                let discountCodeInput = discountCodeInputs[j];
                let discountCodeApplied = discountCodesApplied[j];

                btnApplyDiscountCode && btnApplyDiscountCode.addEventListener('click', async (event) => {
                    event.preventDefault();
                    event.stopPropagation();

                    messageDiscountCode.innerHTML = '';
                    let discountCode = discountCodeInput.value;

                    if (discountCode == null || discountCode.trim() === "") {
                        let messageNull = BSS_B2B.dcTranslations.messageNull;
                        if (BSS_B2B.integrate && BSS_B2B.integrate.langShop && BSS_B2B.integrate.langShop.dcTranslations
                            && BSS_B2B.integrate.langShop.dcTranslations.message_discount_code_null
                        ) {
                            messageNull = BSS_B2B.integrate.langShop.dcTranslations.message_discount_code_null;
                        }
                        messageDiscountCode.style.color = "red";
                        messageDiscountCode.innerHTML = '<span class="bss-b2b-translation-dc-message_discount_code_null">' + messageNull + '</span>';
                    } else {
                        let today = new Date();
                        let moment = today.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });                    
                        today.setUTCHours(0, 0, 0, 0);
                        let shopDataHTML = JSON.parse(document.getElementById('bss-b2b-store-data').innerHTML);
                        let shopDataRes = await fetch(`https://${shopDataHTML.shop.domain}/cart.js`);
                        let shopData = await shopDataRes.json();
                        var handleUrls = [];
                        var handles = [];
                        let keyIdMap = new Map();
                        let keyPriceMap = new Map();
                        let keyQuantityMap = new Map();
                        let totalPrice = 0;
                        let shopModules = BSS_B2B.shopModules;
                        let isEnableCP = true;
                        let isEnableQB = true;
                        shopModules.forEach(function (sm) {
                            if (sm.code === "cp") {
                                isEnableCP = sm.status;
                            } else if (sm.code === "qb") {
                                isEnableQB = sm.status;
                            }
                        });
                        for (let i = 0; i < shopData.items.length; i++) {
                            let item = shopData.items[i];
                            totalPrice += item.line_price;
                            var proId = item.product_id;
                            if (handles.indexOf(proId) === -1) {
                                handles.push(proId);
                                handleUrls.push('id:"' + proId + '"');
                                keyIdMap.set(proId, []);
                                keyPriceMap.set(proId, []);
                                keyQuantityMap.set(proId, []);
                            }

                            let productItemKeys =  keyIdMap.get(proId);
                            productItemKeys.push(item.key)
                            keyIdMap.set(proId, productItemKeys);
                            keyPriceMap.set(proId, item.price);
                            keyQuantityMap.set(proId, item.quantity);
                        }

                        var urlData = '/search.js?q=' + handleUrls.join(' OR ') + '&view=bss.b2b';
                        let productCartPage = await fetch(`https://${shopDataHTML.shop.domain}/${urlData}`);
                        let responseProducts = await productCartPage.json();
                        if (responseProducts.length > 0) {
                            var productMap = []
                            var checkUnique = [];
                            for (var i = 0; i < responseProducts.length; i++) {
                                var pro = responseProducts[i];
                                if (checkUnique.indexOf(pro.id) === -1) {
                                    checkUnique.push(pro.id);
                                    keyIdMap.get(pro.id).forEach(function (key) {
                                        productMap.push({
                                            id: pro.id,
                                            tags: pro.tags,
                                            collections: pro.collections,
                                            key: key,
                                            price:parseFloat(keyPriceMap.get(pro.id)),
                                            title:pro.title,
                                            quantity:parseInt(keyQuantityMap.get(pro.id))
                                        });
                                    })
                                }
                            }

                            let data = {
                                today: today,
                                moment: moment,
                                customer: shopDataHTML.customer,
                                cart_items: productMap,
                                domain: shopDataHTML.shop.permanent_domain,
                                discount_code: discountCode,
                                totalPrice:totalPrice,
                                isEnableCP:isEnableCP,
                                isEnableQB:isEnableQB
                            }
                            if (Shopify.shop === "kraeutermax.myshopify.com") {
                                data.qbRules = BSS_B2B.qbRules
                            }
                            await fetch(bssB2bApiServer + "/dc/rules/get-applied-rule?domain=" + Shopify.shop, {
                                method: "POST",
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(data)
                            })
                                .then(response => response.json())
                                .then(async function (data) {
                                    if (data.success) {
                                        if (BSS_B2B.storeId !== 3793) {
                                            messageDiscountCode.style.color = "green";
                                            messageDiscountCode.innerHTML = data.message;
                                            BSS_B2B.integrate.langShop.handleAllTranslation('dc', ['message_success_discount_code']);
                                            discountCodeInput.setAttribute('discount-code', true);
                                            discountCodeApplied.innerHTML = "<div id=\"bss-b2b-discount-code-applied\">" +
                                                "<span>"
                                                + discountCode +
                                                "</span>" +
                                                "<div id=\"bss-b2b-clear-discount-code\">\n" +
                                                "&#x2716;\n" +
                                                "</div>" +
                                                "</div>";
                                            handleRemoveDiscountCodeApplied();
                                            let dataUpdateJSON = JSON.stringify({
                                                dc_keys: data.listKeysItemAppliedDC,
                                                dc_products: data.listProductIdsAppliedDC,
                                                discount_value: data.discountValue,
                                                discount_type: data.discountType,
                                                discount_code: data.discountCode,
                                                discount_code_type: data.discountCodeType,
                                                token: data.token
                                            });
                                            let dataUpdate = {
                                                attributes: {
                                                    discountCodeRule: dataUpdateJSON
                                                }
                                            };
                                            const cartDataRes = await fetch("/cart/update.js", {
                                                method: "POST",
                                                headers: {
                                                    'Accept': 'application/json',
                                                    'Content-Type': 'application/json'
                                                },
                                                body: JSON.stringify(dataUpdate)
                                            })

                                            if(BSS_B2B.storeId === 7597){
                                                const cartData = await cartDataRes.json();
                                                BSS_B2B.customize.dc.showDiscountPrice(
                                                    BSS_B2B, cartData, 
                                                    JSON.parse(dataUpdateJSON), false
                                                );
                                            }
                                        } else {
                                            BSS_B2B.customize.dc.checkLimitAmount(data, messageDiscountCode, discountCodeInput, discountCodeApplied, Shopify);
                                        }
                                    } else {
                                        messageDiscountCode.style.color = "red";
                                        messageDiscountCode.innerHTML = data.message;
                                        BSS_B2B.integrate.langShop.handleAllTranslation('dc', ['message_error_discount_code']);
                                    }
                                })
                                .catch((error) => {
                                    // eslint-disable-next-line no-console
                                    console.error('Error:', error);
                                });
                        }
                    }
                })
            }
        }
    }

    function handleRemoveDiscountCodeApplied () {
        let clearDiscountCodeBtn = document.getElementById("bss-b2b-clear-discount-code");
        clearDiscountCodeBtn.addEventListener('click', async (event) => {
            event.preventDefault();

            let messageDiscountCodes = document.querySelectorAll("#bss-b2b-discount-code-message");
            let discountCodeInputs = document.querySelectorAll("#bss-b2b-discount-code-input");
            let discountCodesApplied = document.querySelectorAll("#bss-b2b-discount-code-applied-wrapper");

            if (messageDiscountCodes.length && discountCodeInputs.length && discountCodesApplied.length) {
                for (let j = 0; j < messageDiscountCodes.length; j++) {
                    let messageDiscountCode = messageDiscountCodes[j];
                    let discountCodeInput = discountCodeInputs[j];
                    let discountCodeApplied = discountCodesApplied[j];
                    discountCodeInput.value = "";
                    discountCodeInput.removeAttribute('discount-code')
                    discountCodeApplied.innerHTML = "";
                    messageDiscountCode.innerHTML = "";
                }
            }
            let dataUpdateJSON = JSON.stringify({
            })
            let dataUpdate = {
                attributes: {
                    discountCodeRule: dataUpdateJSON
                }
            }
            await fetch("/cart/update.js", {
                method: "POST",
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(dataUpdate)
            })

        })
    }

    setTimeout(() => {
        let headerDiscountForm = document.querySelectorAll(".bss-b2b-translation-dc-form_header_text");
        let btnApply = document.querySelectorAll("#bss-b2b-discount-code-submit span");
        if (headerDiscountForm.length && btnApply.length) {
            headerDiscountForm.forEach((item) => {
                item.innerText = BSS_B2B.dcTranslations.form_header_text;
            });
            btnApply.forEach((item) => {
                item.innerText = BSS_B2B.dcTranslations.button_apply;
            });
        }
    }, 100)

    if (BSS_B2B.storeId !== 2631) {
        handleApplyDiscountCode()
    } else {
        setTimeout(function() {
            handleApplyDiscountCode();
        }, 1000)
    }
</script>
